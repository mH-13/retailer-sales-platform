// Prisma Schema for Retailer Sales Platform
// Database: PostgreSQL
// Design: Optimized for 1M retailers with efficient indexing

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// REFERENCE DATA (Admin-managed)
// ============================================

model Region {
  id        Int       @id @default(autoincrement())
  name      String    @unique @db.VarChar(100)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  areas     Area[]
  retailers Retailer[]

  @@map("regions")
}

model Area {
  id        Int       @id @default(autoincrement())
  name      String    @db.VarChar(100)
  regionId  Int       @map("region_id")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  region      Region      @relation(fields: [regionId], references: [id], onDelete: Restrict)
  territories Territory[]
  retailers   Retailer[]

  // Constraints
  @@unique([name, regionId])
  @@index([regionId])
  @@map("areas")
}

model Distributor {
  id        Int       @id @default(autoincrement())
  name      String    @unique @db.VarChar(100)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  retailers Retailer[]

  @@map("distributors")
}

model Territory {
  id        Int       @id @default(autoincrement())
  name      String    @db.VarChar(100)
  areaId    Int       @map("area_id")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  area      Area       @relation(fields: [areaId], references: [id], onDelete: Restrict)
  retailers Retailer[]

  // Constraints
  @@unique([name, areaId])
  @@index([areaId])
  @@map("territories")
}

// ============================================
// USERS
// ============================================

model SalesRep {
  id           Int      @id @default(autoincrement())
  username     String   @unique @db.VarChar(50)
  name         String   @db.VarChar(100)
  phone        String   @db.VarChar(15)
  passwordHash String   @map("password_hash")
  role         String   @default("SR") @db.VarChar(20) // 'SR' or 'ADMIN'
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  assignments       SalesRepRetailer[] @relation("SalesRepAssignments")
  assignmentsMadeBy SalesRepRetailer[] @relation("AssignedBy")

  // Indexes
  @@index([username])
  @@index([role])
  @@map("sales_reps")
}

// ============================================
// RETAILERS (Main Entity)
// ============================================

model Retailer {
  id            Int      @id @default(autoincrement())
  uid           String   @unique @db.VarChar(50) // Business identifier (e.g., 'RET-DHA-001')
  name          String   @db.VarChar(200)
  phone         String   @db.VarChar(15)

  // Geographic & organizational relationships
  regionId      Int?     @map("region_id")
  areaId        Int?     @map("area_id")
  distributorId Int?     @map("distributor_id")
  territoryId   Int?     @map("territory_id")

  // SR-updatable fields
  points        Int      @default(0)
  routes        String?  @db.Text // Comma-separated or JSON
  notes         String?  @db.Text

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  region      Region?            @relation(fields: [regionId], references: [id], onDelete: SetNull)
  area        Area?              @relation(fields: [areaId], references: [id], onDelete: SetNull)
  distributor Distributor?       @relation(fields: [distributorId], references: [id], onDelete: SetNull)
  territory   Territory?         @relation(fields: [territoryId], references: [id], onDelete: SetNull)
  assignments SalesRepRetailer[]

  // CRITICAL INDEXES for performance
  // These indexes are essential for handling 1M retailers efficiently
  @@index([uid])                                                        // Primary lookup
  @@index([name])                                                       // LIKE searches
  @@index([phone])                                                      // Phone search
  @@index([regionId])                                                   // Filter by region
  @@index([areaId])                                                     // Filter by area
  @@index([distributorId])                                              // Filter by distributor
  @@index([territoryId])                                                // Filter by territory
  @@index([regionId, areaId, distributorId, territoryId])              // Multi-filter queries
  @@index([updatedAt(sort: Desc), id(sort: Desc)])                     // Cursor pagination
  @@map("retailers")
}

// ============================================
// ASSIGNMENTS (Authorization Boundary!)
// ============================================

model SalesRepRetailer {
  id         Int      @id @default(autoincrement())
  salesRepId Int      @map("sales_rep_id")
  retailerId Int      @unique @map("retailer_id") // UNIQUE enforces one SR per retailer
  assignedAt DateTime @default(now()) @map("assigned_at")
  assignedBy Int?     @map("assigned_by") // Admin who made the assignment

  // Relations
  salesRep       SalesRep  @relation("SalesRepAssignments", fields: [salesRepId], references: [id], onDelete: Cascade)
  retailer       Retailer  @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  assignedByUser SalesRep? @relation("AssignedBy", fields: [assignedBy], references: [id])

  // THE MOST IMPORTANT INDEX: Every SR query uses this!
  @@index([salesRepId])
  @@index([retailerId])
  @@index([salesRepId, retailerId]) // Composite for join queries
  @@map("sales_rep_retailers")
}
